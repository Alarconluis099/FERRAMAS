{% extends 'base.html' %}
{% block title %}Ferremas - inicio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_inicio.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_productos.css') }}">
{% endblock %}
{% block content %}

  <!--Productos en promocion--> <!--Slide de imagenes-->
  <section class="seccion-promociones">
    <div id="carouselE" class="carousel slide" data-bs-ride="carousel">
      <div class="carousel-indicators">
        <button type="button" data-bs-target="#carouselE" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
        <button type="button" data-bs-target="#carouselE" data-bs-slide-to="1" aria-current="active" aria-label="Slide 2"></button>
      </div>
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="{{ url_for('static', filename='imagenes/marcas/FERREMAS - BANNER INICIO.png') }}" class="d-block w-100" alt="">
        </div>
        <div class="carousel-item">
          <img src="{{ url_for('static', filename='imagenes/marcas/banner-seguridad.png') }}" class="d-block w-100" alt="">
        </div>
      </div>
      <button class="carousel-control-prev" type="button" data-bs-target="#carouselE" data-bs-slide="prev">
        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        <span class="visually-hidden"> Previous</span>
      </button>
      <button class="carousel-control-next" type="button" data-bs-target="#carouselE" data-bs-slide="next">
        <span class="carousel-control-next-icon" aria-hidden="true"></span>
        <span class="visually-hidden"> Next</span>
      </button>
    </div>
  </section>

  <!-- Categorias - distribuir en fila con texto + logo arriba -->

  <!--Listado dinámico de productos (todos los de la base) -->
  <section class="seccion-productos" id="productos">
    <h2>Productos disponibles</h2>
    <div class="contenedor-productos">
      {% if tools %}
        {% for tool in tools %}
          <div class="producto">
            {# Selección de imagen básica por id; ajustar según tus assets #}
            {% set img_map = {
              100: 'imagenes/marcas/martillo.jpg',
              110: 'imagenes/Herramientas manuales/destornillador.png'
            } %}
            {% set img_src = img_map.get(tool.id_tool, 'Imagenes/Marcas/ferremas.png') %}
            <img src="{{ url_for('static', filename=img_src) }}" alt="{{ tool.name }}">
            <h3 title="{{ tool.name }}">{{ tool.name }}</h3>
            <p>{{ tool.description or 'Sin descripción' }}</p>
            <div class="precio">$ {{ tool.precio }}</div>
            {% if tool.stock is not none %}
              <small class="text-muted" style="font-size:.65rem;">Stock: {{ tool.stock }}</small>
            {% endif %}
            {% if tool.stock is not defined or tool.stock > 0 %}
              <form method="POST" action="{{ url_for('bp.guardar_pedido') }}">
                <input type="hidden" name="product_id" value="{{ tool.id_tool }}">
                <input type="hidden" name="product_name" value="{{ tool.name }}">
                <input type="hidden" name="product_description" value="{{ tool.description }}">
                <input type="hidden" name="product_price" value="{{ tool.precio }}">
                <input type="number" name="cantidad" value="1" min="1" class="form-control form-control-sm mb-1" style="font-size:.65rem;">
                <button type="submit" class="btn-add">Añadir al carrito</button>
              </form>
            {% else %}
              <div class="agotado">Agotado</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
        <p>No hay productos registrados.</p>
      {% endif %}
    </div>
  </section>

  <!-- Marcas -->
  <section class="seccion-marcas">
    <h2>Marcas asociadas</h2>
    <div class="contenedor-marcas">
      <img src="{{ url_for('static', filename='Imagenes/Marcas/Bosch-logo.png') }}" alt="Bosch">
      <img src="{{ url_for('static', filename='Imagenes/Marcas/250px-Makita_Logo.png') }}" alt="Makita">
      <img src="{{ url_for('static', filename='Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png') }}" alt="Stanley">
      <img src="{{ url_for('static', filename='Imagenes/Marcas/Logo_Sika_AG.png') }}" alt="Sika">
    </div>
  </section>

{% endblock %}
{% block extra_js %}{{ super() }}
<script>
document.addEventListener('DOMContentLoaded',()=>{
  const cartCountEl=document.getElementById('cart-count');
  document.querySelectorAll('.producto form').forEach(form=>{
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const payload={
        product_id: fd.get('product_id'),
        product_name: fd.get('product_name'),
        product_description: fd.get('product_description'),
        product_price: fd.get('product_price'),
        cantidad: fd.get('cantidad')
      };
  fetch("{{ url_for('bp.api_guardar_pedido') }}",{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      }).then(r=>r.json()).then(data=>{
        if(data.ok){
          if(cartCountEl){ cartCountEl.textContent=data.cart_count; }
          form.querySelector('[name="cantidad"]').value=1;
          const btn=form.querySelector('button[type="submit"]');
          const old=btn.textContent; btn.textContent='Añadido'; btn.disabled=true;
          setTimeout(()=>{btn.textContent=old; btn.disabled=false;},1200);
        } else {
          alert(data.error||'Error al agregar');
        }
      }).catch(()=>alert('Error de red'));
    });
  });
});
</script>
{% endblock %}
