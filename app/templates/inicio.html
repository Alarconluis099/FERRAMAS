{% extends 'base.html' %}
{% block title %}Ferremas - inicio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_inicio.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_productos.css') }}">
{% endblock %}
{% block content %}
<div class="catalog-light catalog-layout" id="catalog-root" data-api-tools="{{ url_for('bp.api_tools_paginated') }}" data-api-add="{{ url_for('bp.api_guardar_pedido') }}">
  <aside class="filters-panel" aria-label="Filtros de productos">
    <form id="filter-form" onsubmit="return false;" class="fp-layout" data-initial-total="{{ total_tools }}">
      <div class="fp-scroll">
      <div class="fp-head">
        <span id="fp-results-count">{{ total_tools }} resultados</span>
        <button type="button" id="fp-clear-top" class="fp-clear-btn" aria-label="Borrar filtros">Borrar filtros</button>
      </div>
  <div id="active-filters" class="active-filters" aria-live="polite"></div>
      <div class="filter-section">
        <div class="filter-header">Precio oferta</div>
        <div class="price-range dual-handles" id="price-range-container">
          <input type="range" id="price-min-range" min="0" max="1000000" step="1000" value="0" aria-label="Precio mínimo">
          <input type="range" id="price-max-range" min="0" max="1000000" step="1000" value="1000000" aria-label="Precio máximo">
          <div class="value-bubble" id="price-bubble-min">$0</div>
          <div class="value-bubble" id="price-bubble-max">$1.000.000</div>
          <input type="hidden" id="f-precio-min" value="0">
          <input type="hidden" id="f-precio-max" value="1000000">
        </div>
      </div>
      <div class="filter-section">
        <label class="filter-label" for="f-q">Palabras clave</label>
        <input type="text" id="f-q" class="form-control form-control-sm filter-input" placeholder="Buscar..." value="{{ search_query|default('') }}">
      </div>
      <div class="filter-section collapse-group open" data-group>
        <button type="button" class="collapse-toggle" data-toggle-group>
          <span>General</span><i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse-body">
          <!-- Eliminados campos de precio duplicados: ahora los valores se controlan con los inputs de los extremos -->
          <div class="mini-field"><label for="f-order">Ordenar por</label>
            <select id="f-order" class="form-select form-select-sm">
              <option value="">Recientes</option>
              <option value="precio_asc">Precio: menor a mayor</option>
              <option value="precio_desc">Precio: mayor a menor</option>
              <option value="nombre_asc">Nombre A-Z</option>
              <option value="nombre_desc">Nombre Z-A</option>
              <option value="stock_desc">Stock: mayor a menor</option>
              <option value="stock_asc">Stock: menor a mayor</option>
            </select>
          </div>
        </div>
      </div>
      </div><!-- /.fp-scroll -->
    </form>
  </aside>
  <div class="catalog-main">
    <h2 class="catalog-title">Productos disponibles</h2>
    <div class="barra-paginacion pagination-toolbar">
      <div id="range-info">Mostrando <strong>{{ tools|length }}</strong> de <strong>{{ total_tools }}</strong> productos</div>
      <div class="pagination-end">
        <label class="per-page-group">
          <span>Items por pág.</span>
          <select id="per-page-select" class="select-compact">
            {% for opt in allowed_per_page %}
              <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="controles-pagina page-controls">
          <button id="btn-prev" class="btn btn-sm btn-secondary btn-compact" disabled>◀</button>
          <span id="page-indicator">1–{{ tools|length }} de {{ total_tools }}</span>
          <button id="btn-next" class="btn btn-sm btn-secondary btn-compact" {% if tools|length >= total_tools %}disabled{% endif %}>▶</button>
        </div>
      </div>
    </div><!-- /.barra-paginacion -->

    <div id="productos-grid" class="productos-grid" data-total="{{ total_tools }}" data-per-page="{{ per_page }}">
      {% for tool in tools %}
      <div class="producto" data-tool-id="{{ tool.id_tool }}">
        {# Fallback simple: se puede mejorar con lógica de inferencia en JS #}
        <img src="{{ url_for('static', filename='Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png') }}" alt="{{ tool.name }}">
        <h3 title="{{ tool.name }}">{{ tool.name }}</h3>
        <p>{{ tool.description or 'Sin descripción' }}</p>
        <div class="precio">$ {{ tool.precio }}</div>
        {% if tool.stock is none or tool.stock > 0 %}
        <form method="POST" action="#" class="add-form">
          <input type="hidden" name="product_id" value="{{ tool.id_tool }}">
          <input type="number" name="cantidad" value="1" min="1" class="form-control form-control-sm mb-1 qty-input">
          <button type="submit" class="btn-add">Añadir al carrito</button>
        </form>
        {% else %}
        <div class="agotado">Agotado</div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
  </div><!-- /.catalog-main -->
</div><!-- /#catalog-root -->
{% endblock %}

{% block extra_js %}
  {{ super() }}
  <script src="{{ url_for('static', filename='js/catalog.js') }}"></script>
{% endblock %}
