{% extends 'base.html' %}
{% block title %}Ferremas - inicio{% endblock %}
{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_inicio.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/style_productos.css') }}">
{% endblock %}
{% block content %}
<div class="catalog-light catalog-layout" id="catalog-root">
  <aside class="filters-panel" aria-label="Filtros de productos">
    <form id="filter-form" onsubmit="return false;">
      <div class="filter-section">
        <div class="filter-header">Precio oferta</div>
        <div class="price-range">
          <input type="range" id="price-min-range" min="0" max="1000000" step="1000" value="0">
          <input type="range" id="price-max-range" min="0" max="1000000" step="1000" value="1000000">
          <div class="price-values"><span id="price-min-label">$0</span><span id="price-max-label">$1.000.000</span></div>
        </div>
      </div>
      <div class="filter-section">
        <label class="filter-label" for="f-q">Palabras clave</label>
        <input type="text" id="f-q" class="form-control form-control-sm filter-input" placeholder="Buscar..." value="{{ search_query|default('') }}">
      </div>
      <div class="filter-section collapse-group open" data-group>
        <button type="button" class="collapse-toggle" data-toggle-group>
          <span>General</span><i class="bi bi-chevron-down"></i>
        </button>
        <div class="collapse-body">
          <div class="mini-field"><label for="f-precio-min">Precio mínimo</label><input type="number" id="f-precio-min" class="form-control form-control-sm" min="0" placeholder="0"></div>
          <div class="mini-field"><label for="f-precio-max">Precio máximo</label><input type="number" id="f-precio-max" class="form-control form-control-sm" min="0" placeholder=""></div>
          <div class="mini-field"><label for="f-order">Ordenar por</label>
            <select id="f-order" class="form-select form-select-sm">
              <option value="">Recientes</option>
              <option value="precio_asc">Precio: menor a mayor</option>
              <option value="precio_desc">Precio: mayor a menor</option>
              <option value="nombre_asc">Nombre A-Z</option>
              <option value="nombre_desc">Nombre Z-A</option>
              <option value="stock_desc">Stock: mayor a menor</option>
              <option value="stock_asc">Stock: menor a mayor</option>
            </select>
          </div>
        </div>
      </div>
      <div class="filter-actions">
        <button id="btn-apply" class="btn btn-primary btn-sm w-100">Aplicar</button>
        <button id="btn-clear" class="btn btn-outline-light btn-sm w-100" type="button">Limpiar</button>
      </div>
    </form>
  </aside>
  <div class="catalog-main">
    <h2 class="catalog-title">Productos disponibles</h2>
    <div class="barra-paginacion pagination-toolbar">
      <div id="range-info">Mostrando <strong>{{ tools|length }}</strong> de <strong>{{ total_tools }}</strong> productos</div>
      <div class="pagination-end">
        <label class="per-page-group">
          <span>Items por pág.</span>
          <select id="per-page-select" class="select-compact">
            {% for opt in allowed_per_page %}
              <option value="{{ opt }}" {% if opt == per_page %}selected{% endif %}>{{ opt }}</option>
            {% endfor %}
          </select>
        </label>
        <div class="controles-pagina page-controls">
          <button id="btn-prev" class="btn btn-sm btn-secondary btn-compact" disabled>◀</button>
          <span id="page-indicator">1–{{ tools|length }} de {{ total_tools }}</span>
          <button id="btn-next" class="btn btn-sm btn-secondary btn-compact" {% if not has_more %}disabled{% endif %}>▶</button>
        </div>
      </div>
    </div>
    <div id="main-hero" class="hero-carousel mt-5" aria-label="Promociones destacadas">
      <div id="promoCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
          <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
          <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="1" aria-label="Slide 2"></button>
          <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="2" aria-label="Slide 3"></button>
        </div>
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img src="{{ url_for('static', filename='Imagenes/Marcas/banner-herramientas-manuales.png') }}" class="d-block w-100" alt="Herramientas Manuales" loading="lazy">
          </div>
          <div class="carousel-item">
            <img src="{{ url_for('static', filename='Imagenes/Marcas/banner-equipos-seguridad.png') }}" class="d-block w-100" alt="Equipos de Seguridad" loading="lazy">
          </div>
            <div class="carousel-item">
            <img src="{{ url_for('static', filename='Imagenes/Marcas/banner-equipos-medicion.png') }}" class="d-block w-100" alt="Equipos de Medición" loading="lazy">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel" data-bs-slide="prev">
          <span class="carousel-control-prev-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Anterior</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel" data-bs-slide="next">
          <span class="carousel-control-next-icon" aria-hidden="true"></span>
          <span class="visually-hidden">Siguiente</span>
        </button>
      </div>
    </div>
  <div class="contenedor-productos" id="productos-grid" data-total="{{ total_tools }}" data-per-page="{{ per_page }}" data-page="{{ page }}">
      {% if tools %}
        {% for tool in tools %}
          <div class="producto" data-tool-id="{{ tool.id_tool }}">
            {# Selección de imagen básica por id; ajustar según tus assets #}
            {% set img_map = {
              100: 'Imagenes/Herramientas manuales/martillo.png',
              110: 'Imagenes/Herramientas manuales/destornillador.png',
              120: 'Imagenes/Herramientas manuales/llave.png',
              130: 'Imagenes/Herramientas manuales/taladro.png',
              140: 'Imagenes/Herramientas manuales/sierra.png',
              200: 'Imagenes/Equipos de medicion/laser.png',
              210: 'Imagenes/Equipos de medicion/distancia.png',
              300: 'Imagenes/Equipos de seguridad/casco.png',
              310: 'Imagenes/Equipos de seguridad/guantes.png',
              320: 'Imagenes/Equipos de seguridad/lentes.png'
            } %}
            {% set img_src = img_map.get(tool.id_tool, 'Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png') %}
            <img src="{{ url_for('static', filename=img_src) }}" alt="{{ tool.name }}" class="tool-img" data-fallback="{{ url_for('static', filename='Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png') }}">
            <h3 title="{{ tool.name }}">{{ tool.name }}</h3>
            <p>{{ tool.description or 'Sin descripción' }}</p>
            <div class="precio">$ {{ tool.precio }}</div>
            {% if tool.stock is not none %}
              <small class="text-muted stock-note">Stock: {{ tool.stock }}</small>
            {% endif %}
            {% if tool.stock is not defined or tool.stock > 0 %}
              <form method="POST" action="{{ url_for('bp.guardar_pedido') }}">
                <input type="hidden" name="product_id" value="{{ tool.id_tool }}">
                <input type="hidden" name="product_name" value="{{ tool.name }}">
                <input type="hidden" name="product_description" value="{{ tool.description }}">
                <input type="hidden" name="product_price" value="{{ tool.precio }}">
                <input type="number" name="cantidad" value="1" min="1" class="form-control form-control-sm mb-1 qty-input">
                <button type="submit" class="btn-add">Añadir al carrito</button>
              </form>
            {% else %}
              <div class="agotado">Agotado</div>
            {% endif %}
          </div>
        {% endfor %}
      {% else %}
    <p>No hay productos registrados.</p>
      {% endif %}
    </div>
  </div>
</div>

  <!-- Marcas -->
  <section class="seccion-marcas">
    <h2>Marcas asociadas</h2>
    <div class="contenedor-marcas">
  <img src="{{ url_for('static', filename='Imagenes/Marcas/Bosch-logo.png') }}" alt="Bosch" onerror="this.style.display='none'">
  <img src="{{ url_for('static', filename='Imagenes/Marcas/250px-Makita_Logo.png') }}" alt="Makita" onerror="this.style.display='none'">
  <img src="{{ url_for('static', filename='Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png') }}" alt="Stanley" onerror="this.style.display='none'">
  <img src="{{ url_for('static', filename='Imagenes/Marcas/Logo_Sika_AG.png') }}" alt="Sika" onerror="this.style.display='none'">
    </div>
  </section>

{% endblock %}
{% block extra_js %}{{ super() }}
<script>
function bindAddToCart(root=document){
  const cartCountEl=document.getElementById('cart-count');
  root.querySelectorAll('.producto form').forEach(form=>{
    form.addEventListener('submit',e=>{
      e.preventDefault();
      const fd=new FormData(form);
      const payload={
        product_id: fd.get('product_id'),
        product_name: fd.get('product_name'),
        product_description: fd.get('product_description'),
        product_price: fd.get('product_price'),
        cantidad: fd.get('cantidad')
      };
  fetch("{{ url_for('bp.api_guardar_pedido') }}",{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(payload)
      }).then(r=>r.json()).then(data=>{
        if(data.ok){
          if(cartCountEl){ cartCountEl.textContent=data.cart_count; }
          form.querySelector('[name="cantidad"]').value=1;
          const btn=form.querySelector('button[type="submit"]');
          const old=btn.textContent; btn.textContent='Añadido'; btn.disabled=true;
          setTimeout(()=>{btn.textContent=old; btn.disabled=false;},1200);
        } else {
          alert(data.error||'Error al agregar');
        }
      }).catch(()=>alert('Error de red'));
    });
  });
}

document.addEventListener('DOMContentLoaded',()=>{
  // Collapse groups
  document.querySelectorAll('[data-toggle-group]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const grp=btn.closest('[data-group]');
      if(grp) grp.classList.toggle('open');
    });
  });
  // Price range sync
  const rMin=document.getElementById('price-min-range');
  const rMax=document.getElementById('price-max-range');
  const lMin=document.getElementById('price-min-label');
  const lMax=document.getElementById('price-max-label');
  const fMin=document.getElementById('f-precio-min');
  const fMax=document.getElementById('f-precio-max');
  function fmt(v){return '$'+Number(v).toLocaleString('es-CL');}
  function syncFromRanges(){
    if(parseInt(rMin.value)>parseInt(rMax.value)) rMin.value=rMax.value;
    lMin.textContent=fmt(rMin.value); lMax.textContent=fmt(rMax.value);
    fMin.value=rMin.value; fMax.value=rMax.value;
  }
  [rMin,rMax].forEach(el=>el.addEventListener('input',syncFromRanges));
  syncFromRanges();
  // Asignar fallback a imágenes renderizadas inicialmente
  document.querySelectorAll('img.tool-img').forEach(img=>{
    img.addEventListener('error',()=>{
      if(!img.dataset._fallbackApplied){
        img.dataset._fallbackApplied='1';
        img.src = img.getAttribute('data-fallback');
      }
    });
  });
  bindAddToCart();
  const STATIC_BASE = "{{ url_for('static', filename='') }}"; // ends with '/static/'
  const grid=document.getElementById('productos-grid');
  const total=parseInt(grid.dataset.total,10)||0;
  let perPage=parseInt(grid.dataset.perPage,10)||12;
  let page=1;
  const perPageSelect=document.getElementById('per-page-select');
  const btnPrev=document.getElementById('btn-prev');
  const btnNext=document.getElementById('btn-next');
  const pageIndicator=document.getElementById('page-indicator');
  const rangeInfo=document.getElementById('range-info');
  // Filtros
  const fForm=document.getElementById('filter-form');
  const fQ=document.getElementById('f-q');
  const fPMin=document.getElementById('f-precio-min');
  const fPMax=document.getElementById('f-precio-max');
  const fOrder=document.getElementById('f-order');
  const btnApply=document.getElementById('btn-apply');
  const btnClear=document.getElementById('btn-clear');
  let currentFilters={q:null,precio_min:null,precio_max:null,order:null};

  function buildQuery(params){
    const usp=new URLSearchParams();
    Object.entries(params).forEach(([k,v])=>{ if(v!==null && v!=='' && v!==undefined) usp.append(k,v); });
    return usp.toString();
  }
  async function loadPage(newPage, newPerPage){
    const query=buildQuery({
      page:newPage,
      per_page:newPerPage,
      q:currentFilters.q,
      precio_min:currentFilters.precio_min,
      precio_max:currentFilters.precio_max,
      order:currentFilters.order
    });
    const url=`{{ url_for('bp.api_tools_paginated') }}?${query}`;
    const resp=await fetch(url);
    const data=await resp.json();
    if(!data.ok) throw new Error('API');
    // Limpiar grid y montar nuevos
    grid.innerHTML='';
    data.items.forEach(tool=>{
      const div=document.createElement('div');
      div.className='producto';
      div.setAttribute('data-tool-id', tool.id_tool);
  const fallback='Imagenes/Marcas/220px-Stanley_Hand_Tools_logo.png';
  // Intento de inferir categoría simple según nombre
  const lower=(tool.name||'').toLowerCase();
  let inferred=fallback;
  if(/martillo/.test(lower)) inferred='Imagenes/Herramientas manuales/martillo.png';
  else if(/destorn/.test(lower)) inferred='Imagenes/Herramientas manuales/destornillador.png';
  else if(/taladro/.test(lower)) inferred='Imagenes/Herramientas manuales/taladro.png';
  else if(/sierra/.test(lower)) inferred='Imagenes/Herramientas manuales/sierra.png';
  else if(/nivel|laser/.test(lower)) inferred='Imagenes/Equipos de medicion/laser.png';
  else if(/casco/.test(lower)) inferred='Imagenes/Equipos de seguridad/casco.png';
  else if(/guante/.test(lower)) inferred='Imagenes/Equipos de seguridad/guantes.png';
  else if(/lente/.test(lower)) inferred='Imagenes/Equipos de seguridad/lentes.png';
  div.innerHTML=`<img src='${STATIC_BASE + inferred}' alt='${tool.name}' onerror="this.onerror=null;this.src='${STATIC_BASE + fallback}'">
        <h3 title='${tool.name}'>${tool.name}</h3>
        <p>${tool.description || 'Sin descripción'}</p>
        <div class='precio'>$ ${tool.precio}</div>
        ${(tool.stock===null||tool.stock>0)?`<form method='POST' action='#'>
          <input type='hidden' name='product_id' value='${tool.id_tool}'>
          <input type='hidden' name='product_name' value='${tool.name}'>
          <input type='hidden' name='product_description' value='${tool.description||''}'>
          <input type='hidden' name='product_price' value='${tool.precio}'>
          <input type='number' name='cantidad' value='1' min='1' class='form-control form-control-sm mb-1 qty-input'>
          <button type='submit' class='btn-add'>Añadir al carrito</button>
        </form>`:`<div class='agotado'>Agotado</div>`}`;
      grid.appendChild(div);
      bindAddToCart(div);
    });
    page=data.page; perPage=data.per_page;
    const startIdx = (page-1)*perPage + 1;
    const endIdx = Math.min(page*perPage, total);
    pageIndicator.textContent = `${startIdx}–${endIdx} de ${total}`;
    rangeInfo.innerHTML = `Mostrando <strong>${data.items.length}</strong> de <strong>${total}</strong> productos`;
    btnPrev.disabled = page<=1;
    btnNext.disabled = !data.has_more;
  }

  perPageSelect.addEventListener('change',()=>{
    perPage=parseInt(perPageSelect.value,10)||12;
    loadPage(1, perPage).catch(e=>console.warn(e));
  });
  btnApply.addEventListener('click',()=>{
    currentFilters.q = fQ.value.trim()||null;
    currentFilters.precio_min = fPMin.value?parseInt(fPMin.value,10):null;
    currentFilters.precio_max = fPMax.value?parseInt(fPMax.value,10):null;
    currentFilters.order = fOrder.value||null;
    loadPage(1, perPage).catch(e=>console.warn(e));
  });
  btnClear.addEventListener('click',()=>{
    fQ.value=''; fPMin.value=''; fPMax.value=''; fOrder.value='';
    currentFilters={q:null,precio_min:null,precio_max:null,order:null};
    loadPage(1, perPage).catch(e=>console.warn(e));
  });
  btnPrev.addEventListener('click',()=>{
    if(page>1){ loadPage(page-1, perPage).catch(e=>console.warn(e)); }
  });
  btnNext.addEventListener('click',()=>{
    loadPage(page+1, perPage).catch(e=>console.warn(e));
  });
});
</script>
{% endblock %}
