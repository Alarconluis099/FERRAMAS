<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>{% block title %}Ferremas{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
  <style>
    /* Global admin/user font normalization */
    @font-face { font-family: Inter; src: local('Inter'), local('Inter-Regular'); font-weight:400; font-style:normal; }
    body, h1,h2,h3,h4,h5,h6, table, button, input, select, textarea, .btn { font-family: 'Inter', system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>
  <!-- NAVBAR PRINCIPAL -->
  <nav class="navbar app-navbar" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item logo-wrap" href="{{ url_for('bp.inicio') }}" aria-label="Ir al inicio">
        <span class="logo-circle">
          <img src="{{ url_for('static', filename='Imagenes/Marcas/ferremas.png') }}" alt="Ferremas" class="logo-img" />
        </span>
      </a>
      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navbarMain">
        <span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span><span aria-hidden="true"></span>
      </a>
    </div>
    <div id="navbarMain" class="navbar-menu">
  <div class="navbar-start navbar-start-search">
        <form id="top-search-form" action="{{ url_for('bp.inicio') }}" method="get" class="top-search" role="search" aria-label="Buscar productos" autocomplete="off">
          <input type="text" name="q" id="top-search-input" placeholder="¿Qué estás buscando?" value="{{ request.args.get('q','') }}" autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-owns="search-suggestions" aria-haspopup="listbox">
          <button type="submit" aria-label="Buscar"><i class="bi bi-search"></i></button>
          <div id="search-suggestions" class="search-suggestions" role="listbox" aria-label="Sugerencias" hidden></div>
        </form>
      </div>
  <div class="navbar-end nav-action-group">
        <div class="nav-user-block">
          <span class="icon-circle"><i class="bi bi-person"></i></span>
          {% if session.get('usuario') %}
            <div class="user-text">Hola, <a href="{{ url_for('bp.cliente') }}" class="link-inline">{{ session.get('usuario') }}</a>
              <span class="separator-dot">•</span>
              <a href="{{ url_for('bp.logout') }}" class="link-inline">Salir</a>
            </div>
          {% else %}
            <div class="user-text">¡Hola! <a href="{{ url_for('bp.login') }}" class="link-inline">Ingresa</a> o <a href="{{ url_for('bp.registro') }}" class="link-inline">regístrate</a></div>
          {% endif %}
        </div>
        <div class="nav-separator" aria-hidden="true"></div>
        <a href="{{ url_for('bp.carrito') }}" class="nav-cart-block">
          <span class="icon-circle cart-icon"><i class="bi bi-cart"></i></span>
          <span id="cart-count" class="cart-badge">{{ cart_count|default(0) }}</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- FLASH MESSAGES -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="container mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category=='success' else ('danger' if category=='error' else 'info') }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- MAIN CONTENT -->
  <main class="main-content">
    {% block content %}{% endblock %}
  </main>

  <!-- FOOTER -->
  <footer class="site-footer mt-5">
    <div class="footer-top container py-4 py-md-5">
      <div class="row g-4">
        <div class="col-12 col-md-4">
          <h5 class="fw-semibold mb-3">Contáctanos</h5>
          <ul class="list-unstyled small m-0 footer-list">
            <li><a href="https://maps.app.goo.gl/HwFHvTRBiNXT5yFv9" target="_blank" rel="noopener" class="footer-link"><i class="bi bi-building-fill me-2"></i>Antonio Varas 666, Providencia</a></li>
            <li><span class="footer-text"><i class="bi bi-envelope me-2"></i>ferremas@gmail.com</span></li>
            <li><span class="footer-text"><i class="bi bi-telephone-fill me-2"></i>+56 2 23540400</span></li>
          </ul>
        </div>
        <div class="col-6 col-md-2">
          <h5 class="fw-semibold mb-3">Redes</h5>
          <ul class="list-unstyled small m-0 footer-list">
            <li><a href="#" class="footer-link"><i class="bi bi-facebook me-2"></i>Facebook</a></li>
            <li><a href="#" class="footer-link"><i class="bi bi-instagram me-2"></i>Instagram</a></li>
            <li><a href="#" class="footer-link"><i class="bi bi-youtube me-2"></i>Youtube</a></li>
          </ul>
        </div>
        <div class="col-6 col-md-3">
          <h5 class="fw-semibold mb-3">Pago</h5>
          <ul class="list-unstyled small m-0 footer-list">
            <li class="footer-text">Débito</li>
            <li class="footer-text">Crédito</li>
            <li class="footer-text">Transferencia</li>
          </ul>
        </div>
        <div class="col-12 col-md-3 d-flex flex-column align-items-md-end">
          <figure class="m-0 footer-brand"><img src="{{ url_for('static', filename='Imagenes/Marcas/webpay.png') }}" alt="Webpay" class="img-fluid"></figure>
          <p class="small text-muted mt-3 mb-0">Pagos seguros Webpay Plus</p>
        </div>
      </div>
    </div>
    <div class="footer-bottom text-center py-3 small">&copy; 2024 Ferremas. Todos los derechos reservados.</div>
  </footer>

  {% block extra_js %}
  <script>
  document.addEventListener('DOMContentLoaded', function(){
      // (Dark mode eliminado) Forzamos tema claro por simplicidad
      document.documentElement.dataset.theme='light';
      const alerts=document.querySelectorAll('.alert');
      alerts.forEach(a=>setTimeout(()=>{if(a.classList.contains('show')){const inst=bootstrap.Alert.getOrCreateInstance(a);inst.close();}},4000));

  // Ajustar offset si nav fija
  const nav=document.querySelector('.app-navbar');
  if(nav){ const h=nav.offsetHeight; document.documentElement.style.setProperty('--nav-offset', h+'px'); }

  // Autocomplete buscador
  const form=document.getElementById('top-search-form');
  const input=document.getElementById('top-search-input');
  const box=document.getElementById('search-suggestions');
  if(form && input && box){
    let abortCtrl=null; let items=[]; let activeIndex=-1; let lastQuery=''; let debounceTimer=null;
    function clearBox(){ box.innerHTML=''; box.hidden=true; input.setAttribute('aria-expanded','false'); activeIndex=-1; items=[]; }
    function render(list,q){
      if(!list.length){ box.innerHTML='<div class="empty">Sin resultados</div>'; box.hidden=false; input.setAttribute('aria-expanded','true'); return; }
      const qEsc=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');
      const reg=new RegExp(qEsc,'ig');
      box.innerHTML=list.map((it,i)=>{
  const hName=(it.name||'').replace(reg,m=>`<mark class="hl-match">${m}</mark>`);
        return `<div class="sg-item" role="option" data-index="${i}" aria-selected="false" data-id="${it.id_tool}"><span class="name">${hName}</span><span class="price">$ ${it.precio}</span></div>`;
      }).join('');
      box.hidden=false; input.setAttribute('aria-expanded','true'); items=[...box.querySelectorAll('.sg-item')];
    }
    function setActive(i){ if(!items.length) return; items.forEach(el=>el.classList.remove('active')); if(i>=0&&i<items.length){items[i].classList.add('active'); activeIndex=i;} }
    async function fetchSuggestions(q){
      if(abortCtrl) abortCtrl.abort();
      abortCtrl=new AbortController(); form.classList.add('loading');
      try{
        const resp=await fetch(`{{ url_for('bp.api_tool_suggestions') }}?q=${encodeURIComponent(q)}`,{signal:abortCtrl.signal});
        const data=await resp.json();
        if(q!==input.value.trim()) return;
        if(data.ok){ render(data.items,q); } else clearBox();
      }catch(e){ if(e.name!=='AbortError'){ clearBox(); } }
      finally{ form.classList.remove('loading'); }
    }
    input.addEventListener('input',()=>{
      const q=input.value.trim();
      if(q.length<2){ clearBox(); return; }
      if(q===lastQuery) return; lastQuery=q;
      clearTimeout(debounceTimer); debounceTimer=setTimeout(()=>fetchSuggestions(q),170);
    });
    input.addEventListener('keydown',e=>{
      if(box.hidden) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); setActive(activeIndex+1>=items.length?0:activeIndex+1); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(activeIndex-1<0?items.length-1:activeIndex-1); }
      else if(e.key==='Escape'){ clearBox(); }
      else if(e.key==='Enter'){ if(activeIndex>=0){ e.preventDefault(); items[activeIndex].click(); } }
    });
    box.addEventListener('mousedown',e=>{ const it=e.target.closest('.sg-item'); if(!it) return; input.value=it.querySelector('.name').textContent.replace(/\s+/g,' ').trim(); clearBox(); form.submit(); });
    document.addEventListener('click',e=>{ if(!form.contains(e.target)) clearBox(); });
    if(input.value.trim().length>=2){ fetchSuggestions(input.value.trim()); }
  }
    });
  </script>
  {% endblock %}
</body>
</html>
